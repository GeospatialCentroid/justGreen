---
title: "JustGreen Tool Report"
output:
  html_document:
    css: style.css
params:
  cityName: NA
  state: NA
---

```{r load_packages_functions, echo=FALSE, message=FALSE, warning=FALSE}
# Ensure pacman is available
if (!require("pacman")) install.packages("pacman")

# Load packages
pacman::p_load(leaflet, dplyr, readr, sf, terra, plotly, stringr, knitr, kableExtra, ggplot2, RColorBrewer)
sf_use_s2(FALSE)

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
  ### function to round values to N significant digits
  # input:    vec        vector of numeric
  #           n          integer is the required sigfig  
  # output:   outvec     vector of numeric rounded to N sigfig
  formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 
} 

## source gauge chart from app repo - will need to transfer eventually 
source("~/trueNAS/work/justGreenShiny/functions/gaugeChart.R")
```

```{r set input parameters, echo=FALSE, message=FALSE, warning=FALSE}
## all these features should be defined as input parameters before the rmd is called to better hand the path 

test <- FALSE 
if(isTRUE(test)){
  city <- cityName
  state <- state 
}else{
  city <- params$cityName
  state <- params$state   
}

cityHealth <- read_csv("~/trueNAS/work/justGreen/data/products/healthMeasures/allCities_2023_morDemStroke_with10percentAdjust.csv") 
ctHealth <- read_csv("~/trueNAS/work/justGreen/data/products/healthMeasures/allCT_2023_morDemStroke_with10percentAdjust_svi.csv")
totalPop <- read_csv("~/trueNAS/work/justGreen/data/processed/top200_2023/totalPopCities.csv")

# files
cityFiles <- list.files("~/trueNAS/work/justGreen/data/processed/top200_2023", 
                        pattern = ".gpkg",
                        full.names = TRUE)
ctFiles <- list.files("~/trueNAS/work/justGreen/data/processed/censusGeographies", 
                        pattern = "ct.gpkg",
                        full.names = TRUE)
```

```{r filter datasets, echo=FALSE, message=FALSE, warning=FALSE}
if(city %in% c("Augusta-Richmond County consolidated government", "Indianapolis city","Nashville-Davidson metropolitan government")){
  index <- grep(pattern = city, x = totalPop$NAME)
  tPop <- totalPop[index, ] |> pull(totalPopulation)
}else{
  tPop <- totalPop[totalPop$NAME %in% city, ] |> pull(totalPopulation)
}

if(city == "Louisville-Jefferson County metro government"){
  index <- 137
  tPop <- totalPop[index, ] |> pull(totalPopulation)
}

# filter health data to city
## some odd duplicated values returning, dplyr filtering not working well either 
cH <- cityHealth[cityHealth$state == state, ] 
cH <- cH[cH$city == city, ]


ctH <- ctHealth[ctHealth$state == state, ] 
ctH <- ctH[ctH$city == city, ]
ctH <- ctH |>
    mutate(
    geoid = as.character(geoid),      # Force to text
    geoid = str_trim(geoid),          # Remove white space
    geoid = str_pad(geoid, width = 11, side = "left", pad = "0") # Add leading zero
  )

# filter spatial data to state and city
## city level
cS <- terra::vect(cityFiles[grepl(pattern = state, x = cityFiles)])|>
  terra::makeValid()
cS <- cS[cS$NAME == city, ]
## census tract
ctS <- terra::vect(ctFiles[grepl(pattern = state, x = ctFiles)]) |>
  terra::mask(cS)

# index of when ct geoid match
index <- ctS$GEOID %in% ctH$geoid

ctS <- ctS[ctS$GEOID %in% ctH$geoid, ]
ctS$geoid <- ctS$GEOID
# join health data
ctS <- terra::merge(x = ctS, y = ctH, by = "geoid")

# crop the ct to the
crop_ct <- terra::crop(ctS, cS)
# select the census tracts
ct_select <- ctS[ctS$GEOID %in% crop_ct$GEOID,]
# remove all negitive values from the rpl_theme
ct_select$RPL_THEMES <- if_else(ct_select$RPL_THEMES < 0, NA, ct_select$RPL_THEMES)

# Convert to SF for mapping/plotting
ct_sf <- sf::st_as_sf(ct_select)
```

```{r values for report , echo=FALSE, message=FALSE, warning=FALSE}
# ndvi
cityNDVI <- round(cH$meanNDVI, 3)
ndvi_sorted <- cityHealth |>
  arrange(desc(meanNDVI)) |>
  mutate(rank = row_number()) |>
  mutate(percentile = (1 - (rank / n())) * 100)

rankNDVI <- round(ndvi_sorted[ndvi_sorted$city == city, ] |> pull(percentile), 0)

# population
pop_sorted <- totalPop |>
  arrange(desc(totalPopulation)) |>
  mutate(rank = row_number()) |>
  mutate(percentile = (1 - (rank / n())) * 100)

rankPop <- pop_sorted[pop_sorted$NAME == city, ] |> pull(percentile)
pop20 <- cH$popOver20_2023
pop35 <- cH$popOver35_2023
pop55 <- as.numeric(cH$popOver55_2023)

# generate a table for visualization
popTable <- data.frame(
  `total population` = tPop,
  `p20` = pop20,
  `p35` = pop35,
  `p55` = pop55
)

# Apply formatting
popTable_formated <- as.data.frame(
  lapply(popTable, function(x) {
    format(x, big.mark = ",", scientific = FALSE)
  })
)

# --- Format Health Metrics ---
# Note: Ensure these column names match your CSV exactly.
# Based on file context, assuming: ls_Mortality_Count, ls_Mortality_Count_10pct, etc.

mortality_current <- abs(round(cH$ls_Mortality, 0))
mortality_10 <- abs(round(cH$ls_Mortality10, 0))
mortality_diff <- mortality_10 - mortality_current

stroke_current <- abs(round(cH$ls_Stroke, 0))
stroke_10 <- abs(round(cH$ls_Stroke10, 0))
stroke_diff <- stroke_10 - stroke_current

dementia_current <- abs(round(cH$ls_Dementia, 0))
dementia_10 <- abs(round(cH$ls_Dementia10, 0))
dementia_diff <- dementia_10 - dementia_current

# Rate variables
mortality_rate <- round(cH$ls_Mortality_Rate, 1)
stroke_rate <- round(cH$ls_Stroke_Rate, 1)
dementia_rate <- round(cH$ls_Dementia_Rate, 1)
```

## Green Spaces and Health Impact
**Location:** `r paste0(city, ", ",state)` <br>
**Report Date:** `r Sys.Date()`

---

### Summary
**`r city`** has a greenness level (NDVI) of **`r cityNDVI`**, ranking in the **`r rankNDVI`th percentile** among the 200 largest US cities.

```{r summary_table, echo=FALSE}
summary_data <- data.frame(
  Metric = c("Premature deaths prevented annually", "Stroke cases prevented", "Dementia cases prevented"),
  `Current Vegetation Benefits` = c(
    format(mortality_current, big.mark=","),
    format(stroke_current, big.mark=","),
    format(dementia_current, big.mark=",")
  ),
  `Potential with 10% More Vegetation` = c(
    paste(format(mortality_diff, big.mark=","), "additional deaths prevented"),
    paste(format(stroke_diff, big.mark=","), "additional cases prevented"),
    paste(format(dementia_diff, big.mark=","), "additional cases prevented")
  )
)

kable(summary_data, col.names = c("", "Current Vegetation Benefits", "Potential with 10% More Vegetation")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#f2f2f2")
```

---

### Your City's Greenness
* **NDVI:** `r cityNDVI` (0–1 scale)
* **Ranking:** `r rankNDVI`th percentile
* **National average:** 0.59

**Demographics**

```{r pop_table, echo=FALSE}
kable(popTable_formated, col.names = c("Total Population", "Adults 20+", "Adults 35+", "Adults 55+"), align = "c") %>%
  kable_styling(full_width = FALSE, position = "left")
```

**Visual Comparison**

```{r viz_comparison, echo=FALSE, fig.height=2.5, fig.width=8}
# Visualizing ranking
comp_data <- data.frame(
  Label = c("Lowest city", "National average", city, "Highest city"),
  Value = c(0.25, 0.59, cityNDVI, 0.82), # Using 0.25/0.82 as min/max anchors
  Color = c("grey", "grey", "green", "grey")
)
# Ensure order
comp_data$Label <- factor(comp_data$Label, levels = rev(comp_data$Label))

ggplot(comp_data, aes(x = Value, y = Label, fill = Color)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = Value), hjust = -0.2, size = 3.5) +
  scale_fill_manual(values = c("green" = "#1E4D2B", "grey" = "#cccccc")) +
  theme_minimal() +
  labs(x = "NDVI Score", y = "") +
  xlim(0, 1) +
  theme(legend.position = "none",
        panel.grid.major.y = element_blank(),
        axis.text.y = element_text(size=10, face="bold"))
```

---

### Health Benefits of Current Vegetation
The vegetation in **`r city`**—parks, lawns, gardens, shrubs, natural areas—provides measurable health benefits each year.

```{r health_table, echo=FALSE}
health_df <- data.frame(
  Outcome = c("Premature deaths", "Stroke cases", "Dementia cases"),
  Cases = c(format(mortality_current, big.mark=","), format(stroke_current, big.mark=","), format(dementia_current, big.mark=",")),
  Rate = c(mortality_rate, stroke_rate, dementia_rate),
  CI = c(" - ", " - ", " - ") # Placeholder for Confidence Intervals
)

kable(health_df, col.names = c("Outcome", "Annual Cases Prevented", "Rate per 100,000", "95% CI Rate")) %>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE)
```

*These estimates compare current vegetation to a low-greenness scenario (NDVI ≈ 0.2). They draw on meta-analyses of 8+ million people showing approximately 4% lower mortality risk per 0.1-unit NDVI increase.*

---

### What a 10% Increase Could Achieve

```{r scenario_table, echo=FALSE}
scen_df <- data.frame(
  Scenario = c("Current", "+10% vegetation"),
  NDVI = c(cityNDVI, round(cityNDVI * 1.10, 3)),
  Deaths = c(format(mortality_current, big.mark=","),
             paste0(format(mortality_10, big.mark=","), " (+", format(mortality_diff, big.mark=","), ")")),
  Strokes = c(format(stroke_current, big.mark=","),
              paste0(format(stroke_10, big.mark=","), " (+", format(stroke_diff, big.mark=","), ")")),
  Dementia = c(format(dementia_current, big.mark=","),
               paste0(format(dementia_10, big.mark=","), " (+", format(dementia_diff, big.mark=","), ")"))
)

kable(scen_df, align = "c") %>%
  kable_styling(bootstrap_options = "bordered", full_width = TRUE)
```

A 10% increase in NDVI can be achieved through combinations of native plant restoration, park expansion, green infrastructure, and residential landscaping. Native, drought-tolerant vegetation provides equivalent NDVI benefits while requiring less water and maintenance than exotic species.

---
### Priority Areas for Greening
These census tracts have high population density and low vegetation—locations where added green space would benefit the most people.

```{r priority_map, echo=FALSE, message=FALSE, fig.height=5, fig.width=9}
# Create priority data: High Pop (e.g. > median) and Low NDVI (e.g. < median)
# This logic approximates "Priority Areas" logic
ct_sf_clean <- ct_sf %>% filter(!is.na(meanNDVI), !is.na(popOver20_2023))

# Simple priority ranking: Low NDVI * High Pop
ct_sf_clean <- ct_sf_clean %>%
  mutate(priority_score = (1 - meanNDVI) * popOver20_2023) %>%
  arrange(desc(priority_score))

top_5 <- head(ct_sf_clean, 5)

# Render Map
leaflet(ct_sf_clean) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~colorQuantile("YlOrRd", priority_score)(priority_score),
    color = "white", weight = 1, fillOpacity = 0.7,
    popup = ~paste("Tract:", GEOID, "<br>NDVI:", round(meanNDVI,2))
  ) %>%
  addPolygons(data = top_5, color = "blue", weight = 3, fill = FALSE, opacity = 1) %>%
  addLegend("bottomright", colors=c("blue"), labels=c("Top 5 Priority Tracts"))
```

**Top 5 Priority Tracts**
```{r priority_list, echo=FALSE}
priority_table <- top_5 %>%
  sf::st_drop_geometry() %>%
  select(GEOID, meanNDVI, popOver20_2023) %>% # Using 35+ as proxy for adult pop
  mutate(Rank = 1:5, Area = "Neighborhood/Street") %>%
  select(Rank, GEOID, Area, meanNDVI, popOver20_2023)

kable(priority_table, col.names = c("Rank", "Census Tract", "Area Description", "Current NDVI", "Population 20+")) %>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE)
```

<!-- --- -->

### Equity Analysis
The CDC Social Vulnerability Index (SVI) identifies neighborhoods facing socioeconomic and health disadvantages. In many cities, these same neighborhoods have less green space.

```{r equity_table,  message=FALSE,echo=FALSE}
# SVI Analysis
ct_equity <- ct_sf_clean %>% filter(!is.na(RPL_THEMES))

# Create Quartiles
ct_equity <- ct_equity %>%
  mutate(svi_quartile = ntile(RPL_THEMES, 4))

equity_summary <- ct_equity %>%
  group_by(svi_quartile) %>%
  summarise(
    Mean_SVI = mean(RPL_THEMES, na.rm=T),
    Mean_NDVI = mean(meanNDVI, na.rm=T),
    Deaths_Prevented = mean(ls_Mortality_Rate, na.rm=T)
  ) %>%
  st_drop_geometry() %>%
  mutate(Label = c("Lowest vulnerability (Q1)", "Moderate-low (Q2)", "Moderate-high (Q3)", "Highest vulnerability (Q4)")) %>%
  select(Label, Mean_SVI, Mean_NDVI, Deaths_Prevented)

kable(equity_summary, digits = 2, col.names = c("SVI Quartile", "Mean SVI", "Mean NDVI", "Deaths Prevented per 100k")) %>%
  kable_styling(full_width = TRUE)
```

**Interpretation for `r city`**
```{r equity_logic, echo=FALSE, results='asis'}
# Check difference between Q1 and Q4 NDVI
q1_ndvi <- equity_summary$Mean_NDVI[1]
q4_ndvi <- equity_summary$Mean_NDVI[4]
is_equitable <- (q1_ndvi - q4_ndvi) < 0.05 # Threshold assumption

if (is_equitable) {
  cat("**Result: Equitable Distribution.** Greenness is similar across vulnerability quartiles in ", city, ", suggesting relatively equitable distribution. Priority areas for new investment still exist.")
} else {
  cat("**Result: Inequitable Distribution.** Higher-vulnerability neighborhoods have less vegetation than lower-vulnerability areas. This gap means communities with greater health needs receive fewer protective benefits from green space.")
}
```

<!-- --- -->

### Recommendations

**For Local Officials**
* **Set a vegetation target.** `r city` ranks in the `r rankNDVI`th percentile.
* **Direct resources to priority tracts.** Focus on the tracts listed above that combine high need and low current vegetation.
* **Favor native plants in public projects.** Native grasses, shrubs, and ground covers require less water and support local ecosystems.

**For Residents**
* **Add vegetation to your property.** Native plants, ground covers, and gardens all contribute to neighborhood greenness.
* **Choose climate-appropriate species.** Contact your local extension office or native plant society for regionally adapted options.
* **Advocate for green space.** Share this report with local officials. Attend planning meetings when parks or development projects are discussed.

**For Urban Planners**
* **Require vegetation in new development.** Minimum green cover ratios or NDVI targets can be written into zoning.
* **Use green infrastructure.** Bioswales, rain gardens, and permeable surfaces deliver stormwater and health benefits together.
* **Connect green spaces.** Corridors and greenways extend habitat value and resident access.


<!-- --- -->


**Data and Methods**
* **Vegetation (NDVI):** NASA Landsat
* **Population:** US Census ACS
* **Social Vulnerability:** CDC SVI
* **Mortality baseline:** CDC

**Citation:**

"`r city`'s vegetation prevents an estimated `r format(mortality_current, big.mark=",")` premature deaths annually. A 10% increase in green cover could save an additional `r format(mortality_diff, big.mark=",")` lives each year."— *JustGreen Report, Colorado State University, `r format(Sys.Date(), "%Y")`*


**Contact:** david.rojas@colostate.edu

**Created by:** Rojas Lab · Geospatial Centroid · Colorado State University © `r format(Sys.Date(), "%Y")`